// https://docs.renovatebot.com/configuration-options/

{
    "$schema": "https://docs.renovatebot.com/renovate-schema.json",

    "gitlabci": {
        "enabled": false
    },
    "gitlabci-include": {
        "enabled": false
    },

    "packageRules": [
        {
            "matchFileNames": [
                "/\\.gitlab-ci\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/",
                "/\\.gitlab/pipelines/.+\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/"
            ],
            "groupName": "GitLab CI/CD dependencies",
            "groupSlug": "gitlabci-dependencies",
            "semanticCommitType": "ci"
        }
    ],

    "customManagers": [
        {
            "customType": "regex",
            "datasourceTemplate": "docker",
            "description": "Update docker versions in GitLab CI/CD files",
            "managerFilePatterns": [
                "/\\.gitlab-ci\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/",
                "/\\.gitlab/pipelines/.+\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/"
            ],
            "matchStrings": [
                // <text>: <packageName>/<depName>:<currentValue>
                "\\S+:\\s(?<packageName>\\S+\\/(?<depName>\\S+)):(?<currentValue>[\\w.+-]+)$"
            ],
            "versioningTemplate": "docker"
        },
        {
            "customType": "regex",
            "datasourceTemplate": "gitlab-tags",
            "description": "Update 'ref' versions in GitLab CI/CD files",
            "managerFilePatterns": [
                "/\\.gitlab-ci\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/",
                "/\\.gitlab/pipelines/.+\\.ya?ml(?:\\.part)?(?:\\.tmpl)?$/"
            ],
            "matchStrings": [
                // project: <packageName>
                // ref: <currentDigest> # <currentValue>
                "project:\\s(?<packageName>\\S+)\\s+ref:\\s(?<currentDigest>[\\w.+-]+)\\s#\\s(?<currentValue>[\\w.+-]+)$",

                // project: <packageName>
                // ref: <currentValue> (quotes may or may not be there)
                "project:\\s(?<packageName>\\S+)\\s+ref:\\s['\"]?(?<currentValue>[\\w.+-]+)['\"]?$"
            ]
        }
    ]
}
